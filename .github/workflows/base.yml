---
# SPDX-FileCopyrightText: (c) 2021 ale5000
# SPDX-License-Identifier: GPL-3.0-or-later
# SPDX-FileType: SOURCE
name: "Base"
on:
  push:
    branches:
      - main
    tags:
      - "v*"
  pull_request:
  workflow_dispatch:
jobs:
  base-job:
    name: "Coverage and testing"
    runs-on: ubuntu-latest

    steps:
      - name: "Check out code"
        uses: actions/checkout@v3
      - name: "Set up Java"
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'
      - name: "Set up Ruby"
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.0"
      - name: "Install SimpleCov, Bashcov and Codecov"
        run: |
          # Installing SimpleCov, SimpleCov Cobertura and Bashcov...
          gem install simplecov simplecov-cobertura bashcov codecov
      - name: "Execute code coverage"
        id: "coverage"
        env:
          COVERAGE: true
        run: |
          # Executing code coverage...
          #sudo apt-get -qq -y install moreutils 1>/dev/null
          export OPENSOURCE_ONLY='true'
          bash './build.sh' 1>/dev/null
          bashcov './recovery-simulator/recovery.sh' ./output/*.zip
          printf '\n\n'
          #cat "${{ github.workspace }}/coverage/codecov-result.json"
      - name: "Upload reports to Codecov"
        uses: codecov/codecov-action@v3
        with:
          files: "${{ github.workspace }}/coverage/codecov-result.json"
